<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>GBA圖形處理邏輯模擬 (一)</title><meta name="description" content="compilation terminated."><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="

cover

GBA模擬器的開發之路，如果說CPU部分是思考&quot;我到底該怎麼做才對&quot;，那圖形的部分就會是&quot;我到底要怎麼做才會快&quot;
本系列文將會把重點聚焦在如何正確的實作一個GBA的圖形系統模擬函式庫，並提出一些手法來提升模擬的效率

GBA圖形系統規格
相較於近代的主機都普遍配有GPU來負責圖形渲染工作，GBA也有一塊獨立於CPU的處理邏輯負責圖形工作，也就是PPU(Pixel
Processing Unit)
我們可以先來看一下PPU主要提供那些圖形處理功能: 1. 輸出畫面為240*160
pixels 2. 色彩格式為RGB555 3. 具有以下兩種渲染模式: - Tile based:
基於利用尺寸為8*8的tile組合畫面，具有渲染速度快，還可以利用硬體仿射變換功能
-.."><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="黃爸爸狗園" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">0rzgg's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">GBA圖形處理邏輯模擬 (一)</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#gba%E5%9C%96%E5%BD%A2%E7%B3%BB%E7%B5%B1%E8%A6%8F%E6%A0%BC"><span class="toc-text">GBA圖形系統規格</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A8%98%E6%86%B6%E9%AB%94%E5%8D%80%E6%AE%B5"><span class="toc-text">記憶體區段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%96%8B%E7%99%BC%E7%92%B0%E5%A2%83"><span class="toc-text">開發環境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%93%AC%E6%B5%81%E7%A8%8B"><span class="toc-text">模擬流程</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/GBA"><i class="tag post-item-tag">GBA</i></a><a href="/tags/emulator"><i class="tag post-item-tag">emulator</i></a><a href="/tags/graphics"><i class="tag post-item-tag">graphics</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">GBA圖形處理邏輯模擬 (一)</h1><time class="has-text-grey" datetime="2022-07-21T16:13:05.000Z">2022-07-22</time><article class="mt-2 post-content"><figure>
<img src="https://i.imgur.com/SNkM4rS.jpg" alt="cover" />
<figcaption aria-hidden="true">cover</figcaption>
</figure>
<p>GBA模擬器的開發之路，如果說CPU部分是思考"我到底該怎麼做才對"，那圖形的部分就會是"我到底要怎麼做才會<strong><em>快</em></strong>"</p>
<p>本系列文將會把重點聚焦在如何正確的實作一個GBA的圖形系統模擬函式庫，並提出一些手法來提升模擬的效率</p>
<span id="more"></span>
<h2 id="gba圖形系統規格">GBA圖形系統規格</h2>
<p>相較於近代的主機都普遍配有GPU來負責圖形渲染工作，GBA也有一塊獨立於CPU的處理邏輯負責圖形工作，也就是PPU(Pixel
Processing Unit)</p>
<p>我們可以先來看一下PPU主要提供那些圖形處理功能: 1. 輸出畫面為240*160
pixels 2. 色彩格式為RGB555 3. 具有以下兩種渲染模式: - Tile based:
基於利用尺寸為8*8的tile組合畫面，具有渲染速度快，還可以利用硬體仿射變換功能
- Bitmap based:
直接由CPU將圖形資料以Pixel為單位寫入VRAM，自由度較高但效率差，須妥善利用DMA來實作
4. 最大支援128個Sprites於螢幕上顯示 5. 支援數種圖形特效: -
Rotation/Scaling - alpha blending - fade-in/out - mosaic - window</p>
<h2 id="記憶體區段">記憶體區段</h2>
<p>PPU的工作記憶體位於0x0500'0000~0x07ff'ffff，不同的段落具有不同的用途，描述如下:</p>
<figure>
<img src="https://i.imgur.com/X7AeN95.png" alt="memory map" />
<figcaption aria-hidden="true">memory map</figcaption>
</figure>
<ol type="1">
<li>Palette memory: 0x0500'0000 ~ 0x0500'03ff
<ul>
<li>功用為調色盤，一分為二，前半段為背景專用，後半段為OBJ使用</li>
<li>各具有256色，皆為RGB555格式</li>
<li>Bus為16 bit</li>
</ul></li>
<li>Video RAM(VRAM): 0x0600'0000 ~ 0x0601'7fff
<ul>
<li>圖形系統的主記憶體，內容會根據繪圖模式有所不同，後面會詳述</li>
<li>Bus為16 bit</li>
</ul></li>
<li>OBJ Attributes(OAM): 0x0700'0000 ~ 0x0700'03ff
<ul>
<li>用於描述各Sprite的屬性，以及Sprite在作仿射變換時所使用的矩陣內容</li>
<li>Bus為<strong>32 bit</strong></li>
</ul></li>
</ol>
<div class="warning">
<p>聰明的小吉們應該有注意到一件事，我們在上面提到的address為0x0500'0000~0x07ff'ffff</p>
<p>但是下面再說明功能的時候，描述的範圍只有一部分，那剩下沒有涵蓋到(途中的黑色部分)的部分到底有沒有用???</p>
<p>這裡就必須要提及GBA系統的<a
target="_blank" rel="noopener" href="https://www.problemkaputt.de/gbatek.htm#gbaunpredictablethings">Undefined
behavior</a>，其中的Memory
mirror章節有提到GBA硬體的Bus在面對這些奇怪的R/W時會有那些行為</p>
<p>具體模擬的細節我會在MMU相關的文章內作說明</p>
</div>
<h2 id="開發環境">開發環境</h2>
<p>我們的目標是要設計一個負責繪製GBA遊戲畫面的library，而非完全地將邏輯內嵌至模擬器主程式內，所以為了讓我們可以在沒有模擬除了PPU以外的功能的狀態下也能夠對PPU進行debug，我們勢必要開發一個前端，去調用PPU
library所開出的介面來產生畫面</p>
<p>重點來了，阿你就沒有模擬整個系統，PPU怎麼會知道要繪製什麼東西???</p>
<figure>
<img src="https://i.imgur.com/7AER30I.png" alt="pic" />
<figcaption aria-hidden="true">pic</figcaption>
</figure>
<p>而問題的答案也很簡單，找另外一個模擬器，直接去dump他的memory再寫進我們的PPU
memory即可</p>
<p>有一個除錯器<a
target="_blank" rel="noopener" href="https://problemkaputt.de/gba.htm">NO$GBA</a>可以幫我們做到這件事情，我們在後續的開發流程也會持續的使用這個工具來協助我們釐清問題</p>
<h2 id="模擬流程">模擬流程</h2>
<p>上面的說明中我有特別提到PPU在GBA系統中扮演的角色類似於我們現代電腦系統的GPU，但是其工作原理其實與GPU差異很大</p>
<p>現在的GPU基本上擅長一次處理大量的頂點或貼圖資料，但GBA的繪製流程是以scanline為單位，一條一條畫，同時繪圖狀態會根據H-Blank與V-Blank作變化</p>
<p>因此，我們並不會直接就利用GPU來繪製我們模擬器的遊戲畫面，而是先行使用CPU在main
memory上產生出pixel format為RGB555的frame
buffer後，緊接著一次做完整個畫面的RGB555 to
RGBA8888的轉換，最後一步才是透過ImGUI把buffer的內容轉成texture，交由GPU渲染。</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2022/08/03/vector-space/" title="Vector space"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: Vector space</span></a><a class="button is-default" href="/2022/07/19/hardirq/" title="GBA的軟體中斷與其相對應的處理"><span class="has-text-weight-semibold">Next: GBA的軟體中斷與其相對應的處理</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="Haojen/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/GGORZ10227216"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> 0rzgg 2022</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>